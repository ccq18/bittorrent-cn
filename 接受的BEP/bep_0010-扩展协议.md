
http://www.bittorrent.org/beps/bep_0010.html

 

该协议的目的是为bittorrent协议的扩展提供一种简单而精简的传输方式。支持此协议可轻松添加新扩展，而不会干扰标准bittorrent协议或不支持此扩展或要添加的客户端的客户端。

为了向您支持的其他客户端做广告，使用保留字节中的一位。

为扩展协议选择的位是从右起第20位（计数从0开始）。因此（reserved_byte [5]＆0x10）是用于检查客户端是否支持扩展消息传递的表达式。

建立对协议的支持后，客户端应支持1条新消息：

| 名称 | ID |
| --- | --- |
| <tt class="docutils literal">扩展的</tt> | 20 |

该消息与任何其他bittorrent消息一样发送，带有4字节长的前缀和一个标识该消息的单字节（在这种情况下，单字节为20）。在消息有效负载的开头，是一个单字节消息标识符。该标识符可以引用不同的扩展消息，并且仅指定一个ID，即0。如果ID为0，则该消息为握手消息，如下所述。通用<tt class="docutils literal">扩展</tt>消息的布局如下（包括bittorrent协议使用的消息头）：

| 尺寸 | 描述 |
| --- | --- |
| uint32_t | 长度前缀。指定整个消息的字节数。（大端） |
| uint8_t | bittorrent消息ID，= 20 |
| uint8_t | 扩展消息ID。0 =握手，> 0 =握手指定的扩展消息。 |

## 握手消息

握手消息的有效负载是本编码的字典。词典中的所有项目都是可选的。客户端应忽略任何未知名称。字典的所有部分均区分大小写。这是字典中定义的项目：

| 名称 | 描述 |
| --- | --- |
| m | 支持的扩展消息字典，它将每个扩展消息的扩展名映射到扩展消息ID。对这些ID的唯一要求是没有扩展消息共享相同的ID。将分机号设置为零表示不支持/禁用该分机。客户端应忽略任何无法识别的扩展名。扩展消息ID是用于将扩展消息发送给发送此握手消息的对等方的ID。即，ID在此特定对等方是本地的。|

以下是实现可能选择支持的其他一些项目：

| 名称 | 描述 |
| --- | --- |
| p | 本地TCP侦听端口。允许双方了解另一方的TCP端口号。请注意，连接的接收方无需发送此扩展消息，因为它的端口号是已知的。 |
| v | 客户端名称和版本（以utf-8字符串形式）。这是一种比依赖对等ID编码更可靠的标识客户端的方法。 |
| yourip | 一个字符串，包含此对等方将您视为的IP地址的紧凑表示形式。即，这是接收者的外部IP地址（不包括端口）。这可以是IPv4（4字节）或IPv6（16字节）地址。 |
| ipv6 | 如果此对等方具有IPv6接口，则这是该地址的紧凑表示形式（16个字节）。客户端可能更喜欢通过IPv6地址重新连接。 |
| ipv4 | 如果此对等方具有IPv4接口，则这是该地址的紧凑表示形式（4个字节）。客户端可能更喜欢通过此接口重新连接。 |
| reqq | 整数，此客户端支持的未删除请求消息的数目，不丢弃任何数目。libtorrent中的默认值为250。 |

握手字典还可以包括扩展的握手信息，例如对加密头或任何可想象的内容的支持。

握手消息的有效负载可能如下所示：

| 字典 |
| --- |
| <tt class="docutils literal">m</tt> | 

| 字典 |
| --- |
| <tt class="docutils literal">LT_元数据</tt> | 1 |
| <tt class="docutils literal">ut_pex</tt> | 2 |

 |
| <tt class="docutils literal">p</tt> | 6881 |
| <tt class="docutils literal">v</tt> | “ µTorrent 1.2” |

并以编码形式：

```
d1:md11:LT_metadatai1e6:µT_PEXi2ee1:pi6881e1:v13:\xc2\xb5Torrent 1.2e
```
为确保扩展名不会误撞，应在其前面加上两个（或一个）字符代码，用于识别引入扩展的客户端。这既适用于扩展消息名称，也适用于顶级词典中放置的所有其他信息。除非本规范定义，否则所有一个字节标识符和两个字节标识符都将无效。

该消息应在标准bittorrent握手后立即发送给支持此扩展协议的任何对等方。在连接的生存期内多次发送握手消息是有效的，不应断开发送客户端的连接。一个实现可以选择忽略后续的握手消息（或部分握手消息）。

后续握手消息可用于启用/禁用扩展，而无需重新启动连接。如果对等方支持在运行时更改扩展名，则应注意<tt class="docutils literal">m</tt>字典是加法的。这是不够，它包含了实际的_变化_，以扩展名列表。要在运行时禁用对<tt class="docutils literal">LT_metadata</tt>的支持，而不影响任何其他扩展，应该发送此消息： <tt class="docutils literal">d11：LT_metadatai0ee</tt>。如上所述，值0用于关闭扩展名。

必须为每个对等体存储扩展ID，因为对于同一个扩展，每个对等体可能具有不同的ID。

该规范故意不指定任何扩展，例如对等交换或元数据交换。该协议只是对bittorrent协议的实际扩展的一种传输方式，上面示例中命名的扩展（例如<tt class="docutils literal">p</tt>）仅是可能扩展的示例。

## 基本原理

之所以要在握手中定义扩展消息的ID，是为了避免对消息ID进行全局注册。而是，扩展消息的名称需要唯一的名称，如果没有全局注册表，则更容易做到。约定是在扩展消息名称上使用两个字母的前缀，该前缀将标识首先实现扩展消息的客户端。例如<tt class="docutils literal">LT_metadata</tt>由libtorrent实现，因此它具有<tt class="docutils literal">LT</tt>前缀。

如果支持扩展的客户端可以确定接收到的消息将具有的号码，则意味着它们是该客户端中的常数。即它们可以在<tt class="docutils literal">switch</tt>语句中使用。另一端很容易存储具有我们期望的每条消息ID的数组，并在每次发送扩展消息时将其用于查找。

使用字典而不使用数组的原因（对扩展名使用隐式分配的索引号）是，如果客户端要禁用某些扩展名，则ID号将更改，并且将无法使用常量（并且因此，请勿在<tt class="docutils literal">开关中</tt>使用它们）。如果消息ID将直接映射到bittorrent消息ID，则还可以将握手中的扩展名映射到具有固定消息ID的现有扩展名。

将单个字节用作扩展消息标识符的原因是遵循bittorrent规范。及其单字节消息标识符。也被认为是足够的。它不会限制扩展总数，而只会限制同时使用的扩展数量。

将单字节标识符用作标准化握手标识符的原因是：1）主线DHT使用单字节标识符。2）节省带宽。较长消息的唯一优点是它使该协议对人类更具可读性，但是BT协议并未被设计为人类可读的协议，所以何必打扰一下。