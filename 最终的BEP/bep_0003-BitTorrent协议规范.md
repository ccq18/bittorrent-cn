
# BitTorrent协议规范
http://www.bittorrent.org/beps/bep_0003.html

BitTorrent是用于分发文件的协议。它通过URL识别内容，并旨在与Web无缝集成。与纯HTTP相比，它的优势在于，当同一文件同时进行多次下载时，下载器会相互上传，从而使文件源能够支持大量下载器，而其负载却仅适度增加。

## BitTorrent文件分发包含以下实体：

*   普通的Web服务器
*   静态的“ metainfo”文件
*   一个BitTorrent追踪器
*   “原始”下载器
*   最终用户Web浏览器
*   最终用户下载器

理想情况下，单个文件有很多最终用户。

## 要开始投放，主机需要执行以下步骤：

1.  开始运行跟踪器（或者更可能已经运行了一个跟踪器）。
2.  开始运行一台普通的Web服务器，例如apache，或者已经有一个。
3.  将扩展名.torrent与其Web服务器上的mimetype application / x-bittorrent相关联（或已经这样做）。
4.  使用要提供的完整文件和跟踪器的URL生成元信息（.torrent）文件。
5.  将metainfo文件放在Web服务器上。
6.  从其他网页链接到metainfo（.torrent）文件。
7.  启动一个已经具有完整文件（“来源”）的下载器。

## 要开始下载，用户需要执行以下操作：

1.  安装BitTorrent（或已经安装）。
2.  浏览网页。
3.  单击指向.torrent文件的链接。
4.  选择在本地保存文件的位置，或选择部分下载以继续。
5.  等待下载完成。
6.  告诉下载者退出（它会一直上传直到发生这种情况）。

## 本编码

*   字符串以长度为前缀的十进制数为基础，后跟冒号和字符串。例如<tt class="docutils literal">4：spam</tt>对应于“ spam”。
*   整数由“ i”表示，后跟以10为底的数字，再由“ e”表示。例如，<tt class="docutils literal">i3e</tt>对应于3， <tt class="docutils literal">i-3e</tt>对应于-3。整数没有大小限制。<tt class="docutils literal">i-0e</tt>无效。除<tt class="docutils literal">i0e之外</tt>，所有其他带有前导零的编码（例如<tt class="docutils literal">i03e</tt>）均无效，而 <tt class="docutils literal">i0e</tt>当然对应于0。
*   列表被编码为“ l”，后跟元素（也被编码），后跟“ e”。例如<tt class="docutils literal">l4：spam4：eggse</tt> 对应于['spam'，'eggs']。
*   字典被编码为“ d”，后跟一系列交替键及其对应的值，后跟“ e”。例如， <tt class="docutils literal">d3：cow3：moo4：spam4：eggse</tt>对应于{'cow'：'moo'，'spam'：'eggs'}，而<tt class="docutils literal">d4：spaml1：a1：bee</tt>对应于{'spam'：['a' ，'b']}。键必须是字符串，并且必须按排序顺序显示（排序为原始字符串，而不是字母数字）。

## 元信息文件

Metainfo文件（也称为.torrent文件）是具有以下键的按字母顺序分类的词典：

<dt>宣布</dt>

跟踪器的URL。

<dt>信息</dt>

这将映射到字典，其中包含以下说明的键。

.torrent文件中包含文本的所有字符串必须为UTF-8编码。

### 信息词典

的<tt class="docutils literal">名称</tt>键映射到UTF-8编码的字符串这是建议的名称保存文件（或目录），。这纯粹是建议性的。

<tt class="docutils literal">片段长度</tt>映射到文件拆分成的每个片段中的字节数。为了进行传输，文件被分成固定大小的文件，它们的长度都相同，除了最后一个文件可能会被截断。<tt class="docutils literal">片段长度</tt>几乎总是2的幂，最常见的是2 18 = 256 K（3.2版之前的BitTorrent默认使用2 20 = 1 M）。

<tt class="docutils literal">片段</tt>映射到长度为20的倍数的字符串。它将细分为长度为20的字符串，每个字符串都是片段在相应索引处的SHA1哈希。

还有一个密钥<tt class="docutils literal">长度</tt>或一个密钥<tt class="docutils literal">文件</tt>，但不能同时存在或两者都不存在。如果存在<tt class="docutils literal">长度</tt>，则下载代表单个文件，否则代表目录结构中的一组文件。

在单个文件的情况下，<tt class="docutils literal">长度</tt>映射到文件的长度（以字节为单位）。

出于其他键的目的，通过按文件在文件列表中出现的顺序来串联文件，将多文件大小写视为仅具有一个文件。文件列表是值 <tt class="docutils literal">文件</tt>映射到的列表，并且是包含以下键的词典列表：

<tt class="docutils literal">length-</tt>文件的长度，以字节为单位。

<tt class="docutils literal">路径</tt> - UTF-8编码的字符串的对应于子目录名称的列表，其中最后的是实际文件名（长度为零的列表是一个错误的情况下）。

在单文件情况下，名称键是文件名，在多文件情况下，它是目录名。

## 追踪器

跟踪器GET请求具有以下键：

<dt>info_hash</dt>

metainfo文件中info值的bencoded形式的20字节sha1哈希。几乎可以肯定必须逃避该值。

请注意，这是metainfo文件的子字符串。信息哈希必须是在.torrent文件中找到的编码形式的哈希，这与b对metainfo文件进行解码，提取信息字典并_在且仅当_ bdecoder完全验证输入（例如，密钥排序）_时才对其进行_编码相同，缺少前导零）。相反，这意味着客户端必须拒绝无效的元信息文件或直接提取子字符串。他们不得对无效数据执行解码编码往返。

<dt>peer_id</dt>

此下载程序使用长度为20的字符串作为其ID。每个下载器都会在新下载开始时随机生成自己的ID。几乎肯定也必须逃避该值。

<dt>ip</dt>

一个可选参数，提供此对等方所在的IP（或dns名称）。如果它与跟踪器在同一台机器上，则通常用于原点。

<dt>港口</dt>

该对等方正在侦听的端口号。常见的行为是下载者尝试监听6881端口，如果已占用该端口，请尝试6882、6883等，然后在6889之后放弃。

<dt>已上传</dt>

到目前为止，上传的总数量（以10为基础的ascii编码）。

<dt>已下载</dt>

到目前为止下载的总数量，以10为底的ascii编码。

<dt>剩下</dt>

该对等方仍需下载的字节数，以10为底的ascii编码。请注意，由于它可能是恢复文件，因此无法根据下载的文件长度进行计算，并且有可能某些下载的数据未能通过完整性检查，因此必须重新下载。

<dt>事件</dt>

这是一个可选键，它映射到<tt class="docutils literal">start</tt>， <tt class="docutils literal">complete</tt>或<tt class="docutils literal">stop</tt>（或 <tt class="docutils literal">empty</tt>，与不存在相同）。如果不存在，则这是定期发布的公告之一。首次开始下载时，发送使用<tt class="docutils literal">开始</tt>的公告，下载完成时，发送使用<tt class="docutils literal">完成</tt>的公告。没有<tt class="docutils literal">完成</tt>，如果开始的时候文件完整发送。当下载者停止下载时，它们使用<tt class="docutils literal">停止</tt>发送通知。

跟踪器响应是本编码的字典。如果跟踪器响应具有键<tt class="docutils literal">失败原因</tt>，那么它将映射到人类可读的字符串，该字符串解释了查询失败的原因，并且不需要其他键。否则，它必须具有两个键：<tt class="docutils literal">interval</tt>和<tt class="docutils literal">peers</tt>，它们分别对应于下载程序应在常规请求之间等待的秒数。<tt class="docutils literal">peers</tt>映射到与<tt class="docutils literal">peers</tt>对应的字典列表，每个字典包含<tt class="docutils literal">peer id</tt>，<tt class="docutils literal">ip</tt>和 <tt class="docutils literal">port键</tt>，分别映射为对等方的自选ID，IP地址或dns名称（作为字符串）和端口号。请注意，如果事件发生或他们需要更多的同伴，下载者可能会在非预定时间重新请求。

更常见的是，跟踪程序返回对等方列表的紧凑表示形式，请参阅[BEP 23](http://www.bittorrent.org/beps/bep_0023.html)。

如果要对元信息文件或跟踪器查询进行任何扩展，请与Bram Cohen协调以确保所有扩展都兼容。

通常也通过[UDP跟踪器协议](http://www.bittorrent.org/beps/bep_0015.html)进行公告。

## 对等协议

BitTorrent的对等协议通过TCP或[uTP运行](http://www.bittorrent.org/beps/bep_0029.html)。

对等连接是对称的。双向发送的消息看起来相同，并且数据可以双向流动。

对等协议如metainfo文件中所述，从零开始按索引引用文件的各个部分。当对等方完成下载片段并检查哈希是否匹配时，它会向所有对等端宣布已拥有该段。

连接在任一端都包含两个状态位：是否阻塞，是否感兴趣。窒息是一种通知，除非发生窒息，否则不会发送任何数据。阻塞的原因和常见技术将在本文档后面解释。

只要一方感兴趣而另一方不窒息，就会进行数据传输。兴趣状态必须始终保持最新状态-每当下载程序没有任何东西时，他们当前都会要求对方取消选中的内容，尽管他们感到窒息，他们也必须表达出缺乏兴趣。正确实现这一点很棘手，但是使下载者可以知道哪些对等点（如果取消选中）将立即开始下载。

连接开始阻塞，不感兴趣。

传输数据时，下载程序应立即将几个请求排队，以便获得良好的TCP性能（称为“流水线化”。）另一方面，不能立即写到TCP缓冲区的请求应该在内存中排队而不是保留在应用程序级网络缓冲区中，这样在发生阻塞时它们都可以被丢弃。

对等有线协议包括握手，后跟永无止境的长度前缀消息流。握手以字符十九（十进制）开始，后跟字符串“ BitTorrent协议”。前导字符是长度前缀，希望其他新协议也可以做到这一点，从而使它们彼此之间易于区分。

协议中发送的所有后来的整数都被编码为四个字节的big-endian。

固定标头之后是八个保留字节，在所有当前实现中均为零。如果您希望使用这些字节扩展协议，请与Bram Cohen协调以确保所有扩展都兼容。

接下来是metainfo文件中info值的bencoded形式的20字节sha1哈希。（这是与跟踪器宣布为<tt class="docutils literal">info_hash的</tt>值相同，只是在这里是原始值，而不是在此处引用）。如果双方发送的值不同，则它们将断开连接。一个可能的例外是，如果下载程序要在单个端口上进行多次下载，则他们可以等待传入的连接首先给出下载哈希，然后在列表中以相同的响应。

下载哈希值出现后，将在跟踪器请求中报告20字节的对等ID，并将其包含在跟踪器响应的对等列表中。如果接收方的对等ID与发起方期望的对等ID不匹配，则它将切断连接。

握手就是这样，接下来是长度前缀和消息的交替流。长度为零的消息是保持活动状态，并被忽略。Keepalive通常每两分钟发送一次，但是请注意，当需要数据时，超时可以更快地完成。

## 对等消息

所有非Keepalive消息均以给出其类型的单个字节开头。

可能的值为：

*   0-ke
*   1-解除
*   2-感兴趣
*   3-不感兴趣
*   4-有
*   5-位域
*   6-请求
*   7片
*   8-取消

“扼流圈”，“取消扼流圈”，“感兴趣的”和“不感兴趣的”没有有效载荷。

“位域”仅作为第一条消息发送。它的有效载荷是一个位域，下载器已发送的每个索引都设置为1，其余索引设置为0。没有任何内容的下载者可能会跳过“位域”消息。位字段的第一个字节分别对应于从高位到低位的索引0-7。下一个8-15，以此类推。末尾的备用位设置为零。

“ have”消息的有效负载是一个数字，即下载程序刚刚完成并检查其哈希值的索引。

“请求”消息包含索引，开始和长度。最后两个是字节偏移量。长度通常是2的幂，除非在文件末尾被截断。当前所有的实现都使用2 ^ 14（16 kiB），并且关闭连接的请求数量大于此数量。

“取消”消息与请求消息具有相同的有效负载。它们通常仅在下载结束时即所谓的“结束游戏模式”下发送。当下载几乎完成时，有一种趋势是将最后几部分全部从一条软管调制解调器线路上下载，这需要很长时间。为了确保最后几件作品能很快进入市场，一旦对给定下载器的所有作品的请求当前尚未挂起，它就会将所有内容的请求发送给所有正在下载的人。为了防止这种情况变得极其低效，每次发送到零件时，它将取消发送给其他所有人。

“段”消息包含索引，开始和段。请注意，它们与请求消息隐式关联。如果快速连续发送阻塞和取消阻塞消息和/或传输非常缓慢，则可能会出现意外的消息。

下载者通常以随机顺序下载片段，这在防止它们具有任何同级片段的严格子集或超集方面做得相当好。

进行窒息有几个原因。一次通过多个连接发送时，TCP拥塞控制的行为非常差。此外，阻塞可以使每个对等方使用按主题排序算法，以确保他们获得一致的下载速率。

下面描述的阻塞算法是当前部署的算法。所有新算法在完全由其自身组成的网络中以及在由该算法组成的网络中均能良好工作，这一点非常重要。

一个好的扼流算法应该满足几个条件。它应该限制同时上传的数量，以获得良好的TCP性能。它应避免快速cho咽和解un，这被称为“颤动”。它应该与让它下载的同伴互惠。最后，它应该不时尝试未使用的连接，以找出它们是否可能比当前使用的连接更好，这被称为乐观取消。

当前部署的阻塞算法通过仅每十秒钟更改一次阻塞的人员来避免颤动。它取消了四个对等点，它们从那里有最好的下载速率，并且对此感兴趣。具有较高上传速率但不感兴趣的对等方将被阻止，如果对它们感兴趣，则最差的上传方将被阻止。如果下载器具有完整的文件，它将使用其上传速率而不是其下载速率来决定取消锁定的人。

对于开放式取消锁定，在任何时候都可以取消单个对等体，而无论其上载速度如何（如果感兴趣，它将被视为四个允许的下载器之一）。开放式断开的对等体每30秒旋转一次。为了使他们有机会获得完整的作品，新的连接开始的可能性是当前乐观状态的三倍，是旋转中其他地方的。